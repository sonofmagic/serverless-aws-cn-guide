# typescript æ”¯æŒä¸æœ¬åœ°è°ƒè¯•

- [typescript æ”¯æŒä¸æœ¬åœ°è°ƒè¯•](#typescript-æ”¯æŒä¸æœ¬åœ°è°ƒè¯•)
  - [å‰è¨€](#å‰è¨€)
  - [æ”¯æŒ `typescript`](#æ”¯æŒ-typescript)
  - [å‡½æ•°çš„æœ¬åœ°è°ƒè¯•](#å‡½æ•°çš„æœ¬åœ°è°ƒè¯•)
    - [å¯ç”¨ node-terminal è°ƒè¯•](#å¯ç”¨-node-terminal-è°ƒè¯•)
    - [invoke local](#invoke-local)
    - [serverless-offline](#serverless-offline)
  - [Next Chapter](#next-chapter)
  - [ä»£ç ä»¥åŠæ–‡ç« ä»“åº“åœ°å€](#ä»£ç ä»¥åŠæ–‡ç« ä»“åº“åœ°å€)

## å‰è¨€

åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `hello world` å‡½æ•°ï¼Œå¹¶æŠŠå®ƒé¡ºåˆ©çš„éƒ¨ç½²åˆ°äº†`AWS`äº‘ä¸Šã€‚ç„¶è€ŒçœŸæ­£ä¸Šç”Ÿäº§çš„å‡½æ•°é¡¹ç›®è‚¯å®šä¸ä¼šè¿™ä¹ˆç®€å•ã€‚

å¯¹äºä¸€ä¸ªç°ä»£çš„ `nodejs` é¡¹ç›®æ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æœ‰è®¸å¤šçš„éœ€æ±‚ï¼š

æ¯”å¦‚æˆ‘ä»¬ä¹Ÿæ›´æƒ³ä½¿ç”¨ `typescript` æ¥è¿›è¡Œå¼€å‘ï¼Œè¿˜æœ‰æˆ‘ä»¬ä¹Ÿéœ€è¦åœ¨æœ¬åœ°æ­å»ºä¸€å¥—å®Œæ•´çš„æ¨¡æ‹Ÿç¯å¢ƒï¼Œæ¥å¯¹æˆ‘ä»¬ç¼–å†™çš„ä»£ç è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚

æ¯”å¦‚æˆ‘ä»¬è¦æ·»åŠ å¯¹åº”çš„å•å…ƒæµ‹è¯•å’Œ `CI/CD`

åˆæˆ–è€…æ˜¯æˆ‘ä»¬çš„å‡½æ•°é‡Œé¢ï¼Œå„ç§ç¬¬ä¸‰æ–¹çš„ä¾èµ–é¡¹çš„å¤„ç†ï¼Œ`js` ç›¸å…³çš„è¿˜å¥½ï¼Œä½†æ˜¯å…¶ä»–é‚£äº›å’Œå¹³å°ç»‘å®šçš„ `äºŒè¿›åˆ¶æ–‡ä»¶`ï¼Œåˆæˆ–è€…æ˜¯å†…ç½®çš„ `.db/.xdb` ç­‰ç­‰ä¸€äº›æ•°æ®æ–‡ä»¶ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

è¯·å¬æˆ‘å¨“å¨“é“æ¥:

## æ”¯æŒ `typescript`

æˆ‘ä»¬æƒ³è¦ç”¨ `ts` æ¥ç¼–å†™å‡½æ•°è¿›è¡Œè°ƒè¯•å’Œéƒ¨ç½²ï¼Œå¹¸è¿çš„æ˜¯ `serverless` ä¸ºæˆ‘ä»¬æä¾›äº†å¼€ç®±å³ç”¨çš„æ’ä»¶ï¼š

1. [`serverless-plugin-typescript`](https://www.npmjs.com/package/serverless-plugin-typescript), è¿™æ˜¯ç”± `serverless` å®˜æ–¹ç»´æŠ¤çš„ `ts` æ”¯æŒæ–¹æ¡ˆï¼Œæ¨èä½¿ç”¨
2. [`serverless-esbuild`](https://www.npmjs.com/package/serverless-esbuild)ï¼Œè¿™æ˜¯ç¬¬ä¸‰æ–¹ç¼–å†™çš„ï¼Œä½¿ç”¨ `esbuild` å»ç¼–è¯‘ `ts` ä»£ç çš„æ–¹æ¡ˆ

> å½“ç„¶ï¼Œé™¤äº†æ’ä»¶æ–¹æ¡ˆä¹‹å¤–ï¼Œå½“ç„¶ä¹Ÿæœ‰é `serverless` æ’ä»¶çš„ä¼ ç»Ÿæ‰“åŒ…æ–¹æ¡ˆï¼Œå³ç›´æ¥ä½¿ç”¨ `tsc` æˆ–è€… `webpack/rollup/esbuild` åˆæˆ–è€…è¿›ä¸€æ­¥å°è£…çš„ `tsup/unbuild` ç›´æ¥æ„å»ºå‡º `dist` äº§ç‰©ï¼Œç„¶å `sls deploy` ç›´æ¥éƒ¨ç½² `dist` é‡Œä»£ç æ–‡ä»¶çš„æ–¹æ¡ˆã€‚
>
> è¿™ä¸ªä¼ ç»Ÿæ‰“åŒ…æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« ã€Šserverless nodejs é¡¹ç›®æ‰“åŒ…æœ€ä½³å®è·µã€‹ä¼šè¯¦ç»†ä»‹ç»ã€‚

è¿™äº›æ’ä»¶çš„ç”¨æ³•éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å®‰è£…å®ƒä»¬ä¹‹åï¼Œå†æŠŠå®ƒä»¬æ³¨å†Œè¿›ä½ çš„ `serverless.yml` æ–‡ä»¶ä¸­å°±å¯ä»¥äº†ã€‚

æ¯”å¦‚ `serverless-plugin-typescript`, æˆ‘ä»¬å…ˆå®‰è£… `npm i -D serverless-plugin-typescript`

ç„¶ååœ¨ `serverless.yml` ä¸­æ³¨å†Œ:

```yml
# æ³¨å†Œæ’ä»¶ï¼Œä¼ å…¥ä¸€ä¸ªæ•°ç»„
plugins:
  - serverless-plugin-typescript
# æ’ä»¶ä¼ å…¥çš„ options éƒ½åœ¨è¿™ä¸ªå­—æ®µä¸‹
custom:
  # å¯ä»¥ä¸ä¼ å€¼ï¼Œä¸ä¼ é»˜è®¤å€¼è§ https://www.npmjs.com/package/serverless-plugin-typescript
  serverlessPluginTypescript:
    tsConfigFileLocation: "./tsconfig.build.json"
```

æ¥ä¸‹æ¥æ‰§è¡Œ `sls packge` å‘½ä»¤(`sls deploy`çš„å‰ç½®æ‰“åŒ…æˆå‹ç¼©åŒ…æ­¥éª¤)ï¼Œæ’ä»¶å°±ä¼šè‡ªå·±å»æ‰¾å½“å‰ç›®å½•ä¸‹çš„ `tsconfig.build.json`ï¼ˆ`tsConfigFileLocation`æŒ‡å®šï¼‰çš„é…ç½®ï¼Œå»ç¼–è¯‘ `ts` ä»£ç ï¼Œç„¶åæ‰“å…¥å°†è¢«ä¸Šä¼ çš„å‹ç¼©åŒ…é‡Œäº†ã€‚

æ‰“åŒ…åï¼Œä½ å¯ä»¥åœ¨ä½ é…ç½®çš„ `tsconfig` é‡Œ `outDir` ç›®å½•ä¸‹ï¼Œæ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„ç»“æœï¼Œå¹¶è¿›è¡Œæ ¡éªŒã€‚

## å‡½æ•°çš„æœ¬åœ°è°ƒè¯•

æˆ‘ä»¬æœ¬åœ°ç¯å¢ƒï¼Œå»è°ƒè¯•ç¼–å†™çš„äº‘å‡½æ•°ï¼Œæ¯”è¾ƒæ–¹ä¾¿çš„åšæ³•ï¼Œä¸»è¦æœ‰ `2` ç§ï¼š

1. ä¸€ç§ä¸ºæ‰§è¡Œ `sls invoke local -f <function name> -d/-p ...` è¿›è¡Œç›´æ¥è°ƒè¯•
2. å¦å¤–ä¸€ç§ä¸ºé€šè¿‡ `serverless-offline` æ’ä»¶ï¼Œåœ¨æœ¬åœ°æ„å»ºå‡ºæ¨¡æ‹Ÿçš„ `lambda` å’Œ `apiç½‘å…³ç¯å¢ƒ` è¿›è¡Œè°ƒè¯•ï¼Œæ˜¾ç„¶è¿™ç§è°ƒè¯•æ–¹å¼éå¸¸é€‚åˆ `web` æœåŠ¡ã€‚

> æ³¨æ„ï¼Œå› ä¸ºæ•´ä¸ªé¡¹ç›®æ˜¯ `typescript` ç¼–å†™çš„ï¼Œè€Œå®é™…è¿è¡Œå´æ˜¯ `js` æ–‡ä»¶ï¼Œæ‰€ä»¥ä½ ç¼–è¯‘æ—¶ï¼Œå¿…é¡»æ‰“å¼€ `sourcemap` é€‰é¡¹æ‰èƒ½å‘½ä¸­åˆ° `ts`æºç é‡Œçš„æ–­ç‚¹ï¼Œä¸ç„¶åªèƒ½å‘½ä¸­åˆ° `.build/.esbuild` é‡Œ `js` äº§ç‰©çš„ä»£ç ã€‚

### å¯ç”¨ node-terminal è°ƒè¯•

è¿™ä¸ªæ–¹æ³•å…¶å®å¾ˆç®€å•ï¼Œ`node-terminal` ç®€ç›´å°±æ˜¯å¼€ç®±å³ç”¨çš„ï¼Œ

ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ `vscode` ä¸‹æ–¹çš„ç»ˆç«¯ç‚¹å‡»åŠ å·æ—è¾¹çš„ä¸‹æ‹‰`icon`ï¼Œæ·»åŠ  `JavaScript è°ƒè¯•ç»ˆç«¯`ï¼Œç„¶åå†`cd`åˆ°ç›®æ ‡ç›®å½•ä¸­ï¼Œæ‰§è¡Œå¯¹äºçš„è°ƒè¯• `npm script` å³å¯ã€‚

å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨ `.vscode/launch.json` å»ç»´æŠ¤æˆ‘ä»¬çš„è°ƒè¯•è„šæœ¬ï¼ŒåŒæ—¶åœ¨ `vscode debug` ç•Œé¢è¿›è¡Œè°ƒè¯•ã€‚

é…ç½®ç±»ä¼¼äºä¸‹æ–¹ï¼š

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "command": "npm run invoke:local",
      "name": "[hello-world] invoke local",
      "request": "launch",
      "type": "node-terminal",
      "cwd": "${workspaceFolder}/apps/hello-world"
    },
    {
      "command": "npm run offline",
      "name": "[hello-world] offline",
      "request": "launch",
      "type": "node-terminal",
      "cwd": "${workspaceFolder}/apps/hello-world"
    }
  ]
}
```

ä¸‹æ–¹çš„ `invoke local` å’Œ `serverless-offline` éƒ½ç›´æ¥ä½¿ç”¨ä¸Šè¿°çš„ `vscode` é…ç½®ç¤ºä¾‹è¿›è¡Œè°ƒè¯•ã€‚

### invoke local

`sls invoke local -f <function name> -d/-p ...` è¿™ä¸ªå‘½ä»¤æ˜¯ç›´æ¥è°ƒç”¨æœ¬åœ°å‡½æ•°è¿›è¡Œè°ƒè¯•.

å…¶ä¸­ `function name` æ˜¯å‡½æ•°åï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ `serverless.yml` ä¸­æ³¨å†Œçš„åå­—ã€‚

åé¢åŠ çš„ `-d/-p` ç”¨æ¥æ§åˆ¶ä¼ å…¥çš„ `event` å¯¹è±¡ï¼Œ`-d` æ˜¯ `--data` çš„ç¼©å†™ï¼Œä»£è¡¨ç›´æ¥æŠŠè·Ÿåœ¨åé¢çš„å­—ç¬¦ä¸²ä½œä¸º `json` ä¼ å…¥å‡½æ•°è¿›è¡Œè°ƒç”¨ã€‚è€Œ `-p`(`--path`çš„ç¼©å†™)å…¶å®åŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡ `-p` æ˜¯ä¼ å…¥ä¸€ä¸ª `json` æ–‡ä»¶çš„è·¯å¾„ä½œä¸ºå‚æ•°ï¼Œè¯»å–ä¹‹åä¼ å…¥å‡½æ•°è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘æ›´æ¨èä½¿ç”¨ `-p`ã€‚

### serverless-offline

`serverless-offline` æ’ä»¶æ˜¯åœ¨æœ¬åœ°æ¨¡æ‹Ÿå‡ºä¸€ä¸ª `lambda` å’Œ `API Gateway` çš„ç¯å¢ƒè¿›è¡Œéƒ¨ç½²ï¼Œå†èµ·ä¸€ä¸ª `http server` ç›‘å¬ç«¯å£ï¼Œè¿™æ ·æ¥è¿›è¡Œè°ƒè¯•ã€‚

è¿™ç§è°ƒè¯•æ–¹æ³•ï¼Œå…¶å®å’Œæˆ‘ä»¬è°ƒè¯• `express/koa` é¡¹ç›®æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬çš„è·¯ç”±ä¸åœ¨æˆ‘ä»¬çš„ä»£ç é‡Œè¿›è¡Œæ³¨å†Œï¼Œè€Œåœ¨äº `serverless.yml` é‡Œå‡½æ•°å¯¹åº”ç½‘å…³çš„é…ç½®ã€‚

`serverless-offline` æ’ä»¶æ³¨å†Œä¹Ÿéå¸¸çš„ç®€å•:

```yml
# æ³¨å†Œæ’ä»¶
plugins:
  - serverless-offline

custom:
# ä¿®æ”¹é…ç½®é¡¹
  serverless-offline:
    noPrependStageInUrl: true
    noAuth: true
```

æ³¨å†Œå®Œæˆä¹‹åï¼Œä½¿ç”¨ `sls offline` å‘½ä»¤ï¼Œå³å¯å¯åŠ¨ï¼Œçœ‹åˆ°:

```txt
Offline [http for lambda] listening on http://localhost:3000
Function names exposed for local invocation by aws-sdk:
           * hello: aws-http-api-ts-dev-hello

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                                         â”‚
   â”‚   GET | http://localhost:3000/                                          â”‚
   â”‚   POST | http://localhost:3000/2015-03-31/functions/hello/invocations   â”‚
   â”‚                                                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Server ready: http://localhost:3000 ğŸš€
```

ä»£è¡¨å·²ç»å¯åŠ¨å®Œæˆï¼Œæ­¤æ—¶å®ƒçš„è°ƒè¯•ä¹Ÿåªéœ€è¦åƒæˆ‘ä»¬è°ƒè¯• `express/koa/nest` é‚£æ ·ï¼Œç›´æ¥åœ¨ `vscode` é‡Œæ‰“æ–­ç‚¹ï¼Œå³å¯å‘½ä¸­ã€‚

## Next Chapter

ç°åœ¨ä½ å·²ç»å­¦ä¼šäº†æœ¬åœ°è°ƒè¯•å’Œ `typescript` æ”¯æŒã€‚

ä¸‹ä¸€ç¯‡ï¼Œã€Šä¾èµ–é¡¹çš„å¤„ç†ä¸å±‚çš„åˆ›å»ºä¸æ³¨å†Œã€‹ä¸­ï¼Œå°†ä¼šè§£é‡Šä¾èµ–é¡¹çš„å¤„ç†ï¼Œæ¬¢è¿é˜…è¯»ã€‚

## ä»£ç ä»¥åŠæ–‡ç« ä»“åº“åœ°å€

<https://github.com/sonofmagic/serverless-aws-cn-guide>
